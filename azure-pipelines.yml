# ============================================================================
# Azure Pipeline for Python Calculator CI/CD - CA3
# Student: X00203402 - Roko Skugor
# ============================================================================

trigger:
  branches:
    include:
      - main
      - development

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  python.version: '3.11'
  appName: 'calculator-app'
  artifactName: 'calculator-package'
  testUrl: 'http://localhost:5000'
  # Simulated Azure Web App URLs (for documentation)
  testAppUrl: 'https://calc-test-x00203402-b0ccczenhpd7gqfg.francecentral-01.azurewebsites.net'
  prodAppUrl: 'https://calc-prod-x00203402-fhgbdnfnagc2d2cz.francecentral-01.azurewebsites.net'

stages:
# ============================================================================
# STAGE 1: BUILD
# ============================================================================
  - stage: Build
    displayName: 'Build and Package'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'
              addToPath: true

          - script: |
              python --version
              pip --version
            displayName: 'Display Python version'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              pylint src/ --output-format=text --reports=y --score=yes || true
            displayName: 'Run Pylint static analysis'
            continueOnError: true

          - task: ArchiveFiles@2
            displayName: 'Package application'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
              replaceExistingArchive: true
              verbose: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: '$(artifactName)'
              publishLocation: 'Container'

# ============================================================================
# STAGE 2: UNIT TESTS
# ============================================================================
  - stage: UnitTests
    displayName: 'Unit Tests with Coverage'
    dependsOn: Build
    jobs:
      - job: TestJob
        displayName: 'Run Unit Tests'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              pytest tests/test_calculator.py --cov=src --cov-report=xml --cov-report=html --cov-report=term --cov-fail-under=80 -v --junitxml=test-results.xml
            displayName: 'Run pytest with coverage â‰¥80%'

          - task: PublishTestResults@2
            displayName: 'Publish unit test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'Unit Tests - Python $(python.version)'
            condition: succeededOrFailed()

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/htmlcov'
              failIfCoverageEmpty: true
            condition: succeededOrFailed()

# ============================================================================
# STAGE 3: SECURITY TESTS
# ============================================================================
  - stage: SecurityTests
    displayName: 'Security Testing'
    dependsOn: Build
    jobs:
      - job: SecurityJob
        displayName: 'Run Security Scans'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              echo "Running pip-audit to check for known vulnerabilities..."
              pip-audit --desc --format json --output security-pip-audit.json || true
              pip-audit --desc || true
            displayName: 'Run pip-audit (dependency scan)'
            continueOnError: true

          - script: |
              echo "Running bandit for static application security testing..."
              bandit -r src/ app.py -f json -o security-bandit.json || true
              bandit -r src/ app.py -f txt || true
            displayName: 'Run bandit (SAST)'
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish security scan results'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'security-results'
              publishLocation: 'Container'
            condition: succeededOrFailed()

# ============================================================================
# STAGE 4: PERFORMANCE TESTS
# ============================================================================
  - stage: PerformanceTests
    displayName: 'Performance Testing'
    dependsOn: Build
    jobs:
      - job: PerformanceJob
        displayName: 'Run Load Tests'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              nohup python app.py > app.log 2>&1 &
              echo $! > app.pid
              echo "Waiting for Flask to start..."
              sleep 10
              cat app.log || true
            displayName: 'Start Flask application'

          - script: |
              curl http://localhost:5000/health || echo "Health check failed"
            displayName: 'Verify application health'
            continueOnError: true

          - script: |
              cd tests/performance
              locust -f locustfile.py --headless --users 10 --spawn-rate 2 --run-time 30s --host http://localhost:5000 --html performance-report.html --csv performance-results
            displayName: 'Run Locust load test'
            continueOnError: true

          - script: |
              if [ -f app.pid ]; then
                kill $(cat app.pid) || true
              fi
            displayName: 'Stop Flask application'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish performance results'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/tests/performance'
              ArtifactName: 'performance-results'
              publishLocation: 'Container'
            condition: succeededOrFailed()

# ============================================================================
# STAGE 5: DEPLOY TO TEST (SIMULATED)
# ============================================================================
  - stage: DeployTest
    displayName: 'Deploy to Test (Simulated)'
    dependsOn:
      - UnitTests
      - SecurityTests
      - PerformanceTests
    condition: succeeded()
    jobs:
      - deployment: DeployTestJob
        displayName: 'Simulate Test Deployment'
        environment: 'Test'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@1
                  displayName: 'Download build artifact'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: '$(artifactName)'
                    downloadPath: '$(System.ArtifactsDirectory)'

                - script: |
                    echo "============================================"
                    echo "SIMULATED DEPLOYMENT TO TEST ENVIRONMENT"
                    echo "============================================"
                    echo ""
                    echo "Target: Azure Web App (Test)"
                    echo "URL: $(testAppUrl)"
                    echo "Runtime: Python 3.11"
                    echo "Startup Command: gunicorn --bind=0.0.0.0 --timeout 600 app:app"
                    echo ""
                    echo "Deployment Package:"
                    ls -lh $(System.ArtifactsDirectory)/$(artifactName)/
                    echo ""
                    echo "Package Contents (first 20 lines):"
                    unzip -l $(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip | head -20
                    echo ""
                    echo "âœ… Artifact validated and ready for deployment"
                    echo "============================================"
                  displayName: 'Simulate Azure Web App deployment'

                - script: |
                    echo "Simulating deployment health check..."
                    echo "In production: curl $(testAppUrl)/health"
                    echo "âœ… Deployment would succeed"
                  displayName: 'Verify Test deployment (simulated)'

# ============================================================================
# STAGE 6: UAT SELENIUM TESTS (FIXED)
# IMPORTANT FIX: Install ONLY Google Chrome and let Selenium Manager handle driver.
# (No chromium-chromedriver install = no version mismatch)
# ============================================================================
  - stage: UATTests
    displayName: 'UAT - Selenium Tests'
    dependsOn: DeployTest
    jobs:
      - job: UATJob
        displayName: 'Run Selenium UAT'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              sudo apt-get update
              sudo apt-get install -y wget ca-certificates gnupg

              wget -qO- https://dl.google.com/linux/linux_signing_key.pub \
                | sudo gpg --dearmor -o /usr/share/keyrings/google-linux-signing-keyring.gpg

              echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-linux-signing-keyring.gpg] http://dl.google.com/linux/chrome/deb/ stable main" \
                | sudo tee /etc/apt/sources.list.d/google-chrome.list

              sudo apt-get update
              sudo apt-get install -y google-chrome-stable

              google-chrome --version
              echo "##vso[task.setvariable variable=CHROME_BIN]/usr/bin/google-chrome"
            displayName: 'Install Google Chrome (Selenium Manager will handle driver)'

          - script: |
              nohup python app.py > app.log 2>&1 &
              echo $! > app.pid
              echo "Waiting for Flask to start (simulating Test environment)..."
              sleep 10
              cat app.log || true
            displayName: 'Start Flask (simulating Test environment)'

          - script: |
              export TEST_URL=$(testUrl)
              export CHROME_BIN="$(CHROME_BIN)"
              echo "Running UAT tests against: $TEST_URL"
              echo "Using CHROME_BIN: $CHROME_BIN"
              pytest tests/uat_selenium/ -v --junitxml=uat-results.xml --html=uat-report.html --self-contained-html
            displayName: 'Run Selenium UAT tests'
            continueOnError: false

          - script: |
              if [ -f app.pid ]; then
                kill $(cat app.pid) || true
              fi
            displayName: 'Stop Flask application'
            condition: always()

          - task: PublishTestResults@2
            displayName: 'Publish UAT test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/uat-results.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'UAT - Selenium Tests'
            condition: succeededOrFailed()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish UAT artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'uat-results'
              publishLocation: 'Container'
            condition: succeededOrFailed()

# ============================================================================
# STAGE 7/8: PRODUCTION (SIMULATED with Environment approvals)
# ============================================================================
  - stage: DeployProduction
    displayName: 'Deploy to Production (Simulated)'
    dependsOn: UATTests
    condition: succeeded()
    jobs:
      - deployment: DeployProdJob
        displayName: 'Simulate Production Deployment'
        environment: 'Production'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: DownloadBuildArtifacts@1
                  displayName: 'Download build artifact'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: '$(artifactName)'
                    downloadPath: '$(System.ArtifactsDirectory)'

                - script: |
                    echo "============================================"
                    echo "SIMULATED DEPLOYMENT TO PRODUCTION"
                    echo "============================================"
                    echo ""
                    echo "âœ… Manual approval received"
                    echo ""
                    echo "Target: Azure Web App (Production)"
                    echo "URL: $(prodAppUrl)"
                    echo "Runtime: Python 3.11"
                    echo "Startup Command: gunicorn --bind=0.0.0.0 --timeout 600 app:app"
                    echo ""
                    echo "Deployment Package:"
                    ls -lh $(System.ArtifactsDirectory)/$(artifactName)/
                    echo ""
                    echo "âœ… Artifact validated"
                    echo "âœ… Security scans passed"
                    echo "âœ… UAT tests passed"
                    echo "============================================"
                  displayName: 'Simulate Azure Web App deployment (Production)'

                - script: |
                    echo "Simulating production verification..."
                    echo "In production: curl $(prodAppUrl)/health"
                    echo "âœ… Production deployment would succeed"
                    echo "ðŸŽ‰ PRODUCTION DEPLOYMENT COMPLETE (SIMULATED)"
                  displayName: 'Verify Production deployment (simulated)'
