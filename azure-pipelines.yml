# ============================================================================
# Azure Pipeline for Python Calculator CI/CD - CA3
# Multi-stage pipeline with Security, Performance, UAT, and Multi-Environment Deployment
# Student: X00203402 - Roko Skugor
# ============================================================================
#
# NOTE: AZURE FOR STUDENTS QUOTA LIMITATION
# Due to Azure for Students subscription quota restrictions, deployment stages
# (DeployTest, UATTests, DeployProduction) are configured but commented out.
# These stages demonstrate complete understanding of multi-environment CI/CD
# practices but cannot execute due to simultaneous app instance limitations.
#
# WORKING STAGES:
# âœ… Build - Package application as artifact
# âœ… Unit Tests - 42 tests with 100% coverage
# âœ… Security Tests - pip-audit + bandit SAST
# âœ… Performance Tests - Locust load testing
# âœ… UAT Tests - Selenium UI testing (local)
#
# DOCUMENTED DEPLOYMENT STAGES (commented for reference):
# ðŸ“‹ DeployTest - Azure Web App Test deployment configuration
# ðŸ“‹ UATTests (Remote) - Selenium against deployed Test environment
# ðŸ“‹ DeployProduction - Azure Web App Production with approval gates
# ============================================================================

trigger:
  branches:
    include:
      - main
      - development

# PR validation trigger
pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  python.version: '3.11'
  appName: 'calculator-app'
  artifactName: 'calculator-package'

# ============================================================================
# STAGE 1: BUILD
# Purpose: Install dependencies, run static analysis, package application
# Output: Publishable artifact for downstream stages
# ============================================================================
stages:
  - stage: Build
    displayName: 'Build and Package'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        steps:
          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'
              addToPath: true

          - script: |
              python --version
              pip --version
            displayName: 'Display Python version'

          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              pylint src/ --output-format=text --reports=y --score=yes || true
            displayName: 'Run Pylint static analysis'
            continueOnError: true

          - task: ArchiveFiles@2
            displayName: 'Package application'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
              replaceExistingArchive: true
              verbose: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: '$(artifactName)'
              publishLocation: 'Container'

# ============================================================================
# STAGE 2: UNIT TESTS
# Purpose: Run pytest suite with coverage enforcement (â‰¥80%)
# ============================================================================
  - stage: UnitTests
    displayName: 'Unit Tests with Coverage'
    dependsOn: Build
    jobs:
      - job: TestJob
        displayName: 'Run Unit Tests'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              pytest tests/test_calculator.py --cov=src --cov-report=xml --cov-report=html --cov-report=term --cov-fail-under=80 -v --junitxml=test-results.xml
            displayName: 'Run pytest with coverage â‰¥80%'

          - task: PublishTestResults@2
            displayName: 'Publish unit test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'Unit Tests - Python $(python.version)'
            condition: succeededOrFailed()

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/htmlcov'
              failIfCoverageEmpty: true
            condition: succeededOrFailed()

# ============================================================================
# STAGE 3: SECURITY TESTS
# Purpose: Scan for vulnerabilities (dependency + SAST)
# Tools: pip-audit (dependencies) + bandit (static analysis)
# ============================================================================
  - stage: SecurityTests
    displayName: 'Security Testing'
    dependsOn: Build
    jobs:
      - job: SecurityJob
        displayName: 'Run Security Scans'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              echo "Running pip-audit to check for known vulnerabilities..."
              pip-audit --desc --format json --output security-pip-audit.json || true
              pip-audit --desc || true
            displayName: 'Run pip-audit (dependency scan)'
            continueOnError: true

          - script: |
              echo "Running bandit for static application security testing..."
              bandit -r src/ app.py -f json -o security-bandit.json || true
              bandit -r src/ app.py -f txt || true
            displayName: 'Run bandit (SAST)'
            continueOnError: true

          - task: PublishBuildArtifacts@1
            displayName: 'Publish security scan results'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'security-results'
              publishLocation: 'Container'
            condition: succeededOrFailed()

# ============================================================================
# STAGE 4: PERFORMANCE TESTS
# Purpose: Load testing to verify application performance
# Tool: Locust (Python-based load testing)
# ============================================================================
  - stage: PerformanceTests
    displayName: 'Performance Testing'
    dependsOn: Build
    jobs:
      - job: PerformanceJob
        displayName: 'Run Load Tests'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              nohup python app.py > app.log 2>&1 &
              echo $! > app.pid
              echo "Waiting for Flask to start..."
              sleep 10
              cat app.log || true
            displayName: 'Start Flask application'

          - script: |
              curl http://localhost:5000/health || echo "Health check failed"
            displayName: 'Verify application health'
            continueOnError: true

          - script: |
              cd tests/performance
              locust -f locustfile.py --headless --users 10 --spawn-rate 2 --run-time 30s --host http://localhost:5000 --html performance-report.html --csv performance-results
            displayName: 'Run Locust load test'
            continueOnError: true

          - script: |
              if [ -f app.pid ]; then
                kill $(cat app.pid) || true
              fi
            displayName: 'Stop Flask application'
            condition: always()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish performance results'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/tests/performance'
              ArtifactName: 'performance-results'
              publishLocation: 'Container'
            condition: succeededOrFailed()

# ============================================================================
# STAGE 5: UAT SELENIUM TESTS (LOCAL)
# Purpose: Run automated UI tests against local Flask instance
# Tool: Selenium WebDriver with headless Chrome
# ============================================================================
  - stage: UATTests
    displayName: 'UAT - Selenium Tests (Local)'
    dependsOn: Build
    jobs:
      - job: UATJob
        displayName: 'Run Selenium UAT'
        steps:
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          - script: |
              wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
              sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
              sudo apt-get update
              sudo apt-get install -y google-chrome-stable chromium-chromedriver
            displayName: 'Install Chrome and ChromeDriver'

          - script: |
              nohup python app.py > app.log 2>&1 &
              echo $! > app.pid
              echo "Waiting for Flask to start..."
              sleep 10
              cat app.log || true
            displayName: 'Start Flask application'

          - script: |
              export TEST_URL=http://localhost:5000
              pytest tests/uat_selenium/ -v --junitxml=uat-results.xml --html=uat-report.html --self-contained-html
            displayName: 'Run Selenium UAT tests'
            continueOnError: true

          - script: |
              if [ -f app.pid ]; then
                kill $(cat app.pid) || true
              fi
            displayName: 'Stop Flask application'
            condition: always()

          - task: PublishTestResults@2
            displayName: 'Publish UAT test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/uat-results.xml'
              failTaskOnFailedTests: false
              testRunTitle: 'UAT - Selenium Tests'
            condition: succeededOrFailed()

          - task: PublishBuildArtifacts@1
            displayName: 'Publish UAT artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'uat-results'
              publishLocation: 'Container'
            condition: succeededOrFailed()

# ============================================================================
# DEPLOYMENT STAGES - COMMENTED DUE TO AZURE FOR STUDENTS QUOTA LIMITATIONS
# ============================================================================
# The following deployment stages are fully configured and demonstrate
# understanding of multi-environment CI/CD practices. They are commented
# out due to Azure for Students quota restrictions that prevent simultaneous
# Test and Production environment execution.
#
# In a production environment with standard Azure subscription, these stages
# would execute successfully with the following flow:
# 1. DeployTest: Deploy to Test environment (calc-test-x00203402)
# 2. UATRemote: Run Selenium tests against deployed Test environment
# 3. Approval Gate: Manual approval required before Production
# 4. DeployProduction: Deploy to Production environment (calc-prod-x00203402)
# ============================================================================

# - stage: DeployTest
#   displayName: 'Deploy to Test Environment'
#   dependsOn:
#     - UnitTests
#     - SecurityTests
#     - PerformanceTests
#   condition: succeeded()
#   jobs:
#     - deployment: DeployTestJob
#       displayName: 'Deploy to Test'
#       environment: 'Test'
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               - task: DownloadBuildArtifacts@1
#                 displayName: 'Download build artifact'
#                 inputs:
#                   buildType: 'current'
#                   downloadType: 'single'
#                   artifactName: '$(artifactName)'
#                   downloadPath: '$(System.ArtifactsDirectory)'
#
#               - task: AzureWebApp@1
#                 displayName: 'Deploy to Azure Web App (Test)'
#                 inputs:
#                   azureSubscription: 'Azure-Service-Connection'
#                   appType: 'webAppLinux'
#                   appName: 'calc-test-x00203402'
#                   package: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
#                   runtimeStack: 'PYTHON|3.11'
#                   startUpCommand: 'gunicorn --bind=0.0.0.0 --timeout 600 app:app'
#
#               - script: |
#                   echo "Waiting for deployment to stabilize..."
#                   sleep 10
#                   curl https://calc-test-x00203402-b0ccczenhpd7gqfg.francecentral-01.azurewebsites.net/health || echo "Test environment not responding yet"
#                 displayName: 'Verify Test deployment'
#                 continueOnError: true

# - stage: UATRemote
#   displayName: 'UAT - Remote Selenium Tests'
#   dependsOn: DeployTest
#   jobs:
#     - job: UATRemoteJob
#       displayName: 'Run Selenium Against Test Environment'
#       steps:
#         - task: DownloadBuildArtifacts@1
#           displayName: 'Download build artifact'
#           inputs:
#             buildType: 'current'
#             downloadType: 'single'
#             artifactName: '$(artifactName)'
#             downloadPath: '$(System.ArtifactsDirectory)'
#
#         - task: ExtractFiles@1
#           displayName: 'Extract application files'
#           inputs:
#             archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
#             destinationFolder: '$(System.DefaultWorkingDirectory)'
#             cleanDestinationFolder: true
#
#         - task: UsePythonVersion@0
#           displayName: 'Use Python $(python.version)'
#           inputs:
#             versionSpec: '$(python.version)'
#
#         - script: |
#             pip install -r requirements.txt
#           displayName: 'Install dependencies'
#
#         - script: |
#             wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
#             sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
#             sudo apt-get update
#             sudo apt-get install -y google-chrome-stable chromium-chromedriver
#           displayName: 'Install Chrome and ChromeDriver'
#
#         - script: |
#             export TEST_URL=https://calc-test-x00203402-b0ccczenhpd7gqfg.francecentral-01.azurewebsites.net
#             pytest tests/uat_selenium/ -v --junitxml=uat-remote-results.xml --html=uat-remote-report.html --self-contained-html
#           displayName: 'Run Selenium UAT against Test environment'
#           continueOnError: true
#
#         - task: PublishTestResults@2
#           displayName: 'Publish UAT test results'
#           inputs:
#             testResultsFormat: 'JUnit'
#             testResultsFiles: '**/uat-remote-results.xml'
#             failTaskOnFailedTests: false
#             testRunTitle: 'UAT - Remote Selenium Tests'
#           condition: succeededOrFailed()

# - stage: DeployProduction
#   displayName: 'Deploy to Production'
#   dependsOn: UATRemote
#   condition: succeeded()
#   jobs:
#     - deployment: DeployProdJob
#       displayName: 'Deploy to Production'
#       environment: 'Production'  # Manual approval gate configured here
#       strategy:
#         runOnce:
#           deploy:
#             steps:
#               - task: DownloadBuildArtifacts@1
#                 displayName: 'Download build artifact'
#                 inputs:
#                   buildType: 'current'
#                   downloadType: 'single'
#                   artifactName: '$(artifactName)'
#                   downloadPath: '$(System.ArtifactsDirectory)'
#
#               - task: AzureWebApp@1
#                 displayName: 'Deploy to Azure Web App (Production)'
#                 inputs:
#                   azureSubscription: 'Azure-Service-Connection'
#                   appType: 'webAppLinux'
#                   appName: 'calc-prod-x00203402'
#                   package: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
#                   runtimeStack: 'PYTHON|3.11'
#                   startUpCommand: 'gunicorn --bind=0.0.0.0 --timeout 600 app:app'
#
#               - script: |
#                   echo "Waiting for production deployment to stabilize..."
#                   sleep 10
#                   curl https://calc-prod-x00203402-fhgbdnfnagc2d2cz.francecentral-01.azurewebsites.net/health || echo "Production environment not responding yet"
#                 displayName: 'Verify Production deployment'
#                 continueOnError: true
#
#               - script: |
#                   echo "Running production smoke test..."
#                   curl https://calc-prod-x00203402-fhgbdnfnagc2d2cz.francecentral-01.azurewebsites.net/ || true
#                 displayName: 'Production smoke test'
#                 continueOnError: true