# ============================================================================
# Azure Pipeline for Python Calculator CI/CD - CA3
# Multi-stage pipeline with Security, Performance, UAT, and Multi-Environment Deployment
# Student: X00203402 - Roko Skugor
# ============================================================================

trigger:
  branches:
    include:
      - main
      - development

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  python.version: '3.11'
  artifactName: 'calculator-package'
  testUrl: 'http://localhost:5000'
  testAppUrl: 'https://calc-test-x00203402-b0ccczenhpd7gqfg.francecentral-01.azurewebsites.net'
  prodAppUrl: 'https://calc-prod-x00203402-fhgbdnfnagc2d2cz.francecentral-01.azurewebsites.net'

stages:
# =========================
# STAGE 1: BUILD
# =========================
- stage: Build
  displayName: 'Build and Package'
  jobs:
    - job: BuildJob
      displayName: 'Build Application'
      steps:
        - task: UsePythonVersion@0
          displayName: 'Use Python $(python.version)'
          inputs:
            versionSpec: '$(python.version)'
            addToPath: true

        - script: |
            python --version
            pip --version
          displayName: 'Display Python version'

        - script: |
            python -m pip install --upgrade pip
            pip install -r requirements.txt
          displayName: 'Install dependencies'

        - script: |
            pylint src/ --output-format=text --reports=y --score=yes || true
          displayName: 'Run Pylint static analysis'
          continueOnError: true

        - task: ArchiveFiles@2
          displayName: 'Package application'
          inputs:
            rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
            includeRootFolder: false
            archiveType: 'zip'
            archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
            replaceExistingArchive: true
            verbose: true

        - task: PublishBuildArtifacts@1
          displayName: 'Publish build artifact'
          inputs:
            PathtoPublish: '$(Build.ArtifactStagingDirectory)'
            ArtifactName: '$(artifactName)'
            publishLocation: 'Container'

# =========================
# STAGE 2: UNIT TESTS
# =========================
- stage: UnitTests
  displayName: 'Unit Tests with Coverage'
  dependsOn: Build
  jobs:
    - job: TestJob
      displayName: 'Run Unit Tests'
      steps:
        - task: DownloadBuildArtifacts@1
          displayName: 'Download build artifact'
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: '$(artifactName)'
            downloadPath: '$(System.ArtifactsDirectory)'

        - task: ExtractFiles@1
          displayName: 'Extract application files'
          inputs:
            archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
            destinationFolder: '$(System.DefaultWorkingDirectory)'
            cleanDestinationFolder: true

        - task: UsePythonVersion@0
          displayName: 'Use Python $(python.version)'
          inputs:
            versionSpec: '$(python.version)'

        - script: |
            pip install -r requirements.txt
          displayName: 'Install dependencies'

        - script: |
            pytest tests/test_calculator.py \
              --cov=src --cov-report=xml --cov-report=html --cov-report=term \
              --cov-fail-under=80 -v --junitxml=test-results.xml
          displayName: 'Run pytest with coverage ≥80%'

        - task: PublishTestResults@2
          displayName: 'Publish unit test results'
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/test-results.xml'
            failTaskOnFailedTests: true
            testRunTitle: 'Unit Tests - Python $(python.version)'
          condition: succeededOrFailed()

        - task: PublishCodeCoverageResults@2
          displayName: 'Publish code coverage'
          inputs:
            codeCoverageTool: 'Cobertura'
            summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
            reportDirectory: '$(System.DefaultWorkingDirectory)/htmlcov'
            failIfCoverageEmpty: true
          condition: succeededOrFailed()

# =========================
# STAGE 3: SECURITY TESTS
# =========================
- stage: SecurityTests
  displayName: 'Security Testing'
  dependsOn: Build
  jobs:
    - job: SecurityJob
      displayName: 'Run Security Scans'
      steps:
        - task: DownloadBuildArtifacts@1
          displayName: 'Download build artifact'
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: '$(artifactName)'
            downloadPath: '$(System.ArtifactsDirectory)'

        - task: ExtractFiles@1
          displayName: 'Extract application files'
          inputs:
            archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
            destinationFolder: '$(System.DefaultWorkingDirectory)'
            cleanDestinationFolder: true

        - task: UsePythonVersion@0
          displayName: 'Use Python $(python.version)'
          inputs:
            versionSpec: '$(python.version)'

        - script: |
            pip install -r requirements.txt
          displayName: 'Install dependencies'

        - script: |
            echo "Running pip-audit..."
            pip-audit --desc --format json --output security-pip-audit.json || true
            pip-audit --desc || true
          displayName: 'Run pip-audit'
          continueOnError: true

        - script: |
            echo "Running bandit..."
            bandit -r src/ app.py -f json -o security-bandit.json || true
            bandit -r src/ app.py -f txt || true
          displayName: 'Run bandit (SAST)'
          continueOnError: true

        - task: PublishBuildArtifacts@1
          displayName: 'Publish security scan results'
          inputs:
            PathtoPublish: '$(System.DefaultWorkingDirectory)'
            ArtifactName: 'security-results'
            publishLocation: 'Container'
          condition: succeededOrFailed()

# =========================
# STAGE 4: PERFORMANCE TESTS
# =========================
- stage: PerformanceTests
  displayName: 'Performance Testing'
  dependsOn: Build
  jobs:
    - job: PerformanceJob
      displayName: 'Run Load Tests'
      steps:
        - task: DownloadBuildArtifacts@1
          displayName: 'Download build artifact'
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: '$(artifactName)'
            downloadPath: '$(System.ArtifactsDirectory)'

        - task: ExtractFiles@1
          displayName: 'Extract application files'
          inputs:
            archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
            destinationFolder: '$(System.DefaultWorkingDirectory)'
            cleanDestinationFolder: true

        - task: UsePythonVersion@0
          displayName: 'Use Python $(python.version)'
          inputs:
            versionSpec: '$(python.version)'

        - script: |
            pip install -r requirements.txt
          displayName: 'Install dependencies'

        - script: |
            nohup python app.py > app.log 2>&1 &
            echo $! > app.pid
            echo "Waiting for Flask..."
            for i in {1..30}; do
              if curl -fsS http://localhost:5000/health > /dev/null; then
                echo "App is up!"
                break
              fi
              sleep 2
            done
            curl -fsS http://localhost:5000/health
            echo "---- app.log ----"
            tail -n 200 app.log || true
          displayName: 'Start Flask and wait for /health'

        - script: |
            cd tests/performance
            locust -f locustfile.py --headless --users 10 --spawn-rate 2 \
              --run-time 30s --host http://localhost:5000 \
              --html performance-report.html --csv performance-results
          displayName: 'Run Locust load test'
          continueOnError: true

        - script: |
            if [ -f app.pid ]; then
              kill $(cat app.pid) || true
            fi
          displayName: 'Stop Flask'
          condition: always()

        - task: PublishBuildArtifacts@1
          displayName: 'Publish performance results'
          inputs:
            PathtoPublish: '$(System.DefaultWorkingDirectory)/tests/performance'
            ArtifactName: 'performance-results'
            publishLocation: 'Container'
          condition: succeededOrFailed()

# =========================
# STAGE 5: DEPLOY TEST (SIMULATED)
# =========================
- stage: DeployTest
  displayName: 'Deploy to Test (Simulated)'
  dependsOn:
    - UnitTests
    - SecurityTests
    - PerformanceTests
  condition: succeeded()
  jobs:
    - deployment: DeployTestJob
      displayName: 'Simulate Test Deployment'
      environment: 'Test'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadBuildArtifacts@1
                displayName: 'Download build artifact'
                inputs:
                  buildType: 'current'
                  downloadType: 'single'
                  artifactName: '$(artifactName)'
                  downloadPath: '$(System.ArtifactsDirectory)'

              - script: |
                  echo "SIMULATED DEPLOYMENT TO TEST"
                  echo "URL: $(testAppUrl)"
                  ls -lh $(System.ArtifactsDirectory)/$(artifactName)/
                  unzip -l $(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip | head -25
                displayName: 'Simulate deploy'

# =========================
# STAGE 6: UAT SELENIUM (LOCAL)
# =========================
- stage: UATTests
  displayName: 'UAT - Selenium Tests'
  dependsOn: DeployTest
  jobs:
    - job: UATJob
      displayName: 'Run Selenium UAT'
      steps:
        - task: DownloadBuildArtifacts@1
          displayName: 'Download build artifact'
          inputs:
            buildType: 'current'
            downloadType: 'single'
            artifactName: '$(artifactName)'
            downloadPath: '$(System.ArtifactsDirectory)'

        - task: ExtractFiles@1
          displayName: 'Extract application files'
          inputs:
            archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
            destinationFolder: '$(System.DefaultWorkingDirectory)'
            cleanDestinationFolder: true

        - task: UsePythonVersion@0
          displayName: 'Use Python $(python.version)'
          inputs:
            versionSpec: '$(python.version)'

        - script: |
            pip install -r requirements.txt
          displayName: 'Install dependencies'

        - script: |
            set -e
            sudo apt-get update
            sudo apt-get install -y google-chrome-stable chromium-chromedriver
            echo "Chrome:"
            which google-chrome
            google-chrome --version
            echo "Chromedriver:"
            which chromedriver || true
            chromedriver --version || true
          displayName: 'Install Chrome + Chromedriver (and print versions)'

        - script: |
            nohup python app.py > app.log 2>&1 &
            echo $! > app.pid

            echo "Waiting for Flask /health..."
            for i in {1..30}; do
              if curl -fsS http://localhost:5000/health > /dev/null; then
                echo "✅ App ready"
                break
              fi
              sleep 2
            done

            echo "Health response:"
            curl -fsS http://localhost:5000/health
            echo "---- app.log ----"
            tail -n 200 app.log || true
          displayName: 'Start Flask and wait until ready'

        - script: |
            export TEST_URL=$(testUrl)
            export CHROME_BIN=/usr/bin/google-chrome
            export CHROMEDRIVER_PATH=/usr/bin/chromedriver
            echo "Running UAT tests against: $TEST_URL"
            pytest tests/uat_selenium/ -v -o addopts="" \
              --junitxml=uat-results.xml \
              --html=uat-report.html --self-contained-html
          displayName: 'Run Selenium UAT tests'

        - script: |
            if [ -f app.pid ]; then
              kill $(cat app.pid) || true
            fi
          displayName: 'Stop Flask'
          condition: always()

        - task: PublishTestResults@2
          displayName: 'Publish UAT test results'
          inputs:
            testResultsFormat: 'JUnit'
            testResultsFiles: '**/uat-results.xml'
            failTaskOnFailedTests: true
            testRunTitle: 'UAT - Selenium Tests'
          condition: succeededOrFailed()

        - task: PublishBuildArtifacts@1
          displayName: 'Publish UAT artifacts'
          inputs:
            PathtoPublish: '$(System.DefaultWorkingDirectory)'
            ArtifactName: 'uat-results'
            publishLocation: 'Container'
          condition: succeededOrFailed()

# =========================
# STAGE 7/8: PROD DEPLOY (SIMULATED) + APPROVAL VIA ENVIRONMENT
# =========================
- stage: DeployProduction
  displayName: 'Deploy to Production (Simulated)'
  dependsOn: UATTests
  condition: succeeded()
  jobs:
    - deployment: DeployProdJob
      displayName: 'Simulate Production Deployment'
      environment: 'Production'
      strategy:
        runOnce:
          deploy:
            steps:
              - task: DownloadBuildArtifacts@1
                displayName: 'Download build artifact'
                inputs:
                  buildType: 'current'
                  downloadType: 'single'
                  artifactName: '$(artifactName)'
                  downloadPath: '$(System.ArtifactsDirectory)'

              - script: |
                  echo "SIMULATED DEPLOYMENT TO PRODUCTION"
                  echo "URL: $(prodAppUrl)"
                  ls -lh $(System.ArtifactsDirectory)/$(artifactName)/
                displayName: 'Simulate prod deploy'
