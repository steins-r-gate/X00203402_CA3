# Azure Pipeline for Python Calculator CI/CD - CA3
# Multi-stage pipeline with Security, Performance, UAT, and Multi-Environment Deployment
# Student: X00203402 - Roko Skugor
# Triggers on pushes to main and development branches

trigger:
  branches:
    include:
      - main
      - development

# PR validation trigger
pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  python.version: '3.11'
  # Application settings
  appName: 'calculator-app'
  artifactName: 'calculator-package'

# ============================================================================
# STAGE 1: BUILD
# Purpose: Install dependencies, run static analysis, package application
# Output: Publishable artifact for downstream stages
# ============================================================================
stages:
  - stage: Build
    displayName: 'Build and Package'
    jobs:
      - job: BuildJob
        displayName: 'Build Application'
        steps:
          # Setup Python environment
          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'
              addToPath: true

          # Display environment info for debugging
          - script: |
              python --version
              pip --version
            displayName: 'Display Python version'

          # Install all dependencies including new ones for CA3
          - script: |
              python -m pip install --upgrade pip
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          # Static code analysis (inherited from CA2)
          - script: |
              pylint src/ --output-format=text --reports=y --score=yes || true
            displayName: 'Run Pylint static analysis'
            continueOnError: true

          # Package application as artifact
          # This creates a distributable package for deployment
          - task: ArchiveFiles@2
            displayName: 'Package application'
            inputs:
              rootFolderOrFile: '$(System.DefaultWorkingDirectory)'
              includeRootFolder: false
              archiveType: 'zip'
              archiveFile: '$(Build.ArtifactStagingDirectory)/$(artifactName).zip'
              replaceExistingArchive: true
              verbose: true

          # Publish artifact for use in subsequent stages
          # This avoids rebuilding in each stage
          - task: PublishBuildArtifacts@1
            displayName: 'Publish build artifact'
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: '$(artifactName)'
              publishLocation: 'Container'

# ============================================================================
# STAGE 2: UNIT TESTS
# Purpose: Run pytest suite with coverage enforcement (≥80%)
# Inherited from CA2, now as separate stage
# ============================================================================
  - stage: UnitTests
    displayName: 'Unit Tests with Coverage'
    dependsOn: Build
    jobs:
      - job: TestJob
        displayName: 'Run Unit Tests'
        steps:
          # Download artifact from Build stage
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          # Extract artifact
          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          # Setup Python
          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          # Install dependencies
          - script: |
              pip install -r requirements.txt
            displayName: 'Install dependencies'

          # Run unit tests with coverage (CA2 requirement maintained)
          - script: |
              pytest --cov=src --cov-report=xml --cov-report=html --cov-report=term --cov-fail-under=80 -v --junitxml=test-results.xml
            displayName: 'Run pytest with coverage ≥80%'

          # Publish test results to Azure DevOps
          - task: PublishTestResults@2
            displayName: 'Publish unit test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/test-results.xml'
              failTaskOnFailedTests: true
              testRunTitle: 'Unit Tests - Python $(python.version)'
            condition: succeededOrFailed()

          # Publish coverage results
          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage'
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
              reportDirectory: '$(System.DefaultWorkingDirectory)/htmlcov'
              failIfCoverageEmpty: true
            condition: succeededOrFailed()

# ============================================================================
# STAGE 3: SECURITY TESTS
# Purpose: Scan for vulnerabilities (dependency + SAST)
# Tools: pip-audit (dependencies) + bandit (static analysis)
# ============================================================================
  - stage: SecurityTests
    displayName: 'Security Testing'
    dependsOn: Build
    jobs:
      - job: SecurityJob
        displayName: 'Run Security Scans'
        steps:
          # Download artifact
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          # Extract artifact
          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          # Setup Python
          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          # Install dependencies + security tools
          - script: |
              pip install -r requirements.txt
              pip install pip-audit bandit
            displayName: 'Install dependencies and security tools'

          # Dependency vulnerability scan with pip-audit
          - script: |
              echo "Running pip-audit to check for known vulnerabilities..."
              pip-audit --desc --format json --output security-pip-audit.json || true
              pip-audit --desc || true
            displayName: 'Run pip-audit (dependency scan)'
            continueOnError: true

          # SAST scan with bandit
          - script: |
              echo "Running bandit for static application security testing..."
              bandit -r src/ -f json -o security-bandit.json || true
              bandit -r src/ -f txt || true
            displayName: 'Run bandit (SAST)'
            continueOnError: true

          # Publish security results as artifacts
          - task: PublishBuildArtifacts@1
            displayName: 'Publish security scan results'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'security-results'
              publishLocation: 'Container'
            condition: succeededOrFailed()

# ============================================================================
# STAGE 4: PERFORMANCE TESTS
# Purpose: Load testing to verify application performance
# Tool: Locust (Python-based load testing)
# ============================================================================
  - stage: PerformanceTests
    displayName: 'Performance Testing'
    dependsOn: Build
    jobs:
      - job: PerformanceJob
        displayName: 'Run Load Tests'
        steps:
          # Download artifact
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          # Extract artifact
          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          # Setup Python
          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          # Install dependencies + Locust
          - script: |
              pip install -r requirements.txt
              pip install locust
            displayName: 'Install dependencies and Locust'

          # Start Flask app in background
          - script: |
              nohup python app.py > app.log 2>&1 &
              echo $! > app.pid
              sleep 5
              echo "Application started on port 5000"
              cat app.log || true
            displayName: 'Start Flask application'

          # Verify app is running
          - script: |
              curl http://localhost:5000/health || echo "Health check failed"
            displayName: 'Verify application health'
            continueOnError: true

          # Run Locust load test
          - script: |
              cd tests/performance
              locust -f locustfile.py --headless --users 10 --spawn-rate 2 --run-time 30s --host http://localhost:5000 --html performance-report.html --csv performance-results
            displayName: 'Run Locust load test'
            continueOnError: true

          # Stop Flask app
          - script: |
              if [ -f app.pid ]; then
                kill $(cat app.pid) || true
              fi
            displayName: 'Stop Flask application'
            condition: always()

          # Publish performance results
          - task: PublishBuildArtifacts@1
            displayName: 'Publish performance results'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)/tests/performance'
              ArtifactName: 'performance-results'
              publishLocation: 'Container'
            condition: succeededOrFailed()

# ============================================================================
# STAGE 5: DEPLOY TO TEST ENVIRONMENT
# Purpose: Deploy application to Azure Web App (Test)
# Uses Azure App Service deployment task
# ============================================================================
  - stage: DeployTest
    displayName: 'Deploy to Test Environment'
    dependsOn:
      - UnitTests
      - SecurityTests
      - PerformanceTests
    condition: succeeded()
    jobs:
      - deployment: DeployTestJob
        displayName: 'Deploy to Test'
        environment: 'Test'  # Creates approval gate in Azure DevOps
        strategy:
          runOnce:
            deploy:
              steps:
                # Download artifact
                - task: DownloadBuildArtifacts@1
                  displayName: 'Download build artifact'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: '$(artifactName)'
                    downloadPath: '$(System.ArtifactsDirectory)'

                # Deploy to Azure Web App (Test)
                - task: AzureWebApp@1
                  displayName: 'Deploy to Azure Web App (Test)'
                  inputs:
                    azureSubscription: 'Azure-Service-Connection'  # Replace with your service connection name
                    appType: 'webAppLinux'
                    appName: 'calculator-app-test-x00203402'  # Replace with your Test app name
                    package: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
                    runtimeStack: 'PYTHON|3.11'
                    startUpCommand: 'gunicorn --bind=0.0.0.0 --timeout 600 app:app'

                # Verify deployment
                - script: |
                    echo "Waiting for deployment to stabilize..."
                    sleep 10
                    curl https://calculator-app-test-x00203402.azurewebsites.net/health || echo "Test environment not responding yet"
                  displayName: 'Verify Test deployment'
                  continueOnError: true

# ============================================================================
# STAGE 6: UAT SELENIUM TESTS
# Purpose: Run automated UI tests against Test environment
# Tool: Selenium WebDriver with headless Chrome
# ============================================================================
  - stage: UATTests
    displayName: 'UAT - Selenium Tests'
    dependsOn: DeployTest
    jobs:
      - job: UATJob
        displayName: 'Run Selenium UAT'
        steps:
          # Download artifact (contains test code)
          - task: DownloadBuildArtifacts@1
            displayName: 'Download build artifact'
            inputs:
              buildType: 'current'
              downloadType: 'single'
              artifactName: '$(artifactName)'
              downloadPath: '$(System.ArtifactsDirectory)'

          # Extract artifact
          - task: ExtractFiles@1
            displayName: 'Extract application files'
            inputs:
              archiveFilePatterns: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
              destinationFolder: '$(System.DefaultWorkingDirectory)'
              cleanDestinationFolder: true

          # Setup Python
          - task: UsePythonVersion@0
            displayName: 'Use Python $(python.version)'
            inputs:
              versionSpec: '$(python.version)'

          # Install dependencies + Selenium
          - script: |
              pip install -r requirements.txt
              pip install selenium pytest-selenium
            displayName: 'Install dependencies and Selenium'

          # Install Chrome and ChromeDriver
          - script: |
              wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
              sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
              sudo apt-get update
              sudo apt-get install -y google-chrome-stable chromium-chromedriver
            displayName: 'Install Chrome and ChromeDriver'

          # Run Selenium tests against Test environment
          - script: |
              export TEST_URL=https://calculator-app-test-x00203402.azurewebsites.net
              pytest tests/uat_selenium/ -v --junitxml=uat-results.xml --html=uat-report.html --self-contained-html
            displayName: 'Run Selenium UAT tests'
            continueOnError: true

          # Publish UAT test results
          - task: PublishTestResults@2
            displayName: 'Publish UAT test results'
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/uat-results.xml'
              failTaskOnFailedTests: false
              testRunTitle: 'UAT - Selenium Tests'
            condition: succeededOrFailed()

          # Publish screenshots and reports
          - task: PublishBuildArtifacts@1
            displayName: 'Publish UAT artifacts'
            inputs:
              PathtoPublish: '$(System.DefaultWorkingDirectory)'
              ArtifactName: 'uat-results'
              publishLocation: 'Container'
            condition: succeededOrFailed()

# ============================================================================
# STAGE 7: DEPLOY TO PRODUCTION
# Purpose: Deploy to production after manual approval
# Approval gate configured in Azure DevOps Environments
# ============================================================================
  - stage: DeployProduction
    displayName: 'Deploy to Production'
    dependsOn: UATTests
    condition: succeeded()
    jobs:
      - deployment: DeployProdJob
        displayName: 'Deploy to Production'
        environment: 'Production'  # Manual approval required (configured in Azure DevOps)
        strategy:
          runOnce:
            deploy:
              steps:
                # Download artifact
                - task: DownloadBuildArtifacts@1
                  displayName: 'Download build artifact'
                  inputs:
                    buildType: 'current'
                    downloadType: 'single'
                    artifactName: '$(artifactName)'
                    downloadPath: '$(System.ArtifactsDirectory)'

                # Deploy to Azure Web App (Production)
                - task: AzureWebApp@1
                  displayName: 'Deploy to Azure Web App (Production)'
                  inputs:
                    azureSubscription: 'Azure-Service-Connection'  # Replace with your service connection name
                    appType: 'webAppLinux'
                    appName: 'calculator-app-prod-x00203402'  # Replace with your Prod app name
                    package: '$(System.ArtifactsDirectory)/$(artifactName)/$(artifactName).zip'
                    runtimeStack: 'PYTHON|3.11'
                    startUpCommand: 'gunicorn --bind=0.0.0.0 --timeout 600 app:app'

                # Verify production deployment
                - script: |
                    echo "Waiting for production deployment to stabilize..."
                    sleep 10
                    curl https://calculator-app-prod-x00203402.azurewebsites.net/health || echo "Production environment not responding yet"
                  displayName: 'Verify Production deployment'
                  continueOnError: true

                # Final smoke test
                - script: |
                    echo "Running production smoke test..."
                    curl https://calculator-app-prod-x00203402.azurewebsites.net/ || true
                  displayName: 'Production smoke test'
                  continueOnError: true
